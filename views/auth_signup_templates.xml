<?xml version="1.0" encoding="utf-8"?>
<odoo>
     <template id="signup_fields_extended" inherit_id="auth_signup.signup">
        <xpath expr="//form[hasclass('oe_signup_form')]" position="inside">
            <!-- Cloudflare Turnstile - Modificado para mejor compatibilidad -->
            <div class="mb-3 field-captcha">
                <label class="form-label">Verificación de Seguridad</label>
                <!-- Contenedor para Turnstile con ID único -->
                <div id="cf-turnstile-container" class="cf-turnstile"
                     data-sitekey="0x4AAAAAAA-dpmO_dMh_oBeK"
                     data-theme="light"
                     data-action="signup">
                </div>

                <!-- Campo oculto para almacenar el token del Captcha -->
                <input type="hidden" name="cf-turnstile-response" id="cf-turnstile-response"/>

                <!-- Cambio en la forma de verificar el error para evitar problemas con objetos Markup -->
                <t t-if="error">
                    <div t-if="isinstance(error, dict) and error.get('captcha')"
                         class="alert alert-danger mt-2"
                         role="alert">
                        <t t-esc="error.get('captcha')"/>
                    </div>
                </t>
            </div>

            <!-- Términos y condiciones -->
            <div class="mb-3 field-terms">
                <div class="form-check">
                    <input type="checkbox"
                           name="accept_terms"
                           id="accept_terms"
                           class="form-check-input"
                           required="required"/>
                    <label for="accept_terms" class="form-check-label">
                        Acepto los <a href="/page/terminos" target="_blank">términos y condiciones</a>
                    </label>
                </div>
                <!-- Cambio en la forma de verificar el error para evitar problemas con objetos Markup -->
                <t t-if="error">
                    <div t-if="isinstance(error, dict) and error.get('terms')"
                         class="alert alert-danger mt-2"
                         role="alert">
                        <t t-esc="error.get('terms')"/>
                    </div>
                </t>
            </div>

            <!-- Mensaje de verificación de correo -->
            <div class="alert alert-info mb-3">
                <i class="fa fa-info-circle me-2"></i> Se enviará un código de verificación a tu correo electrónico.
            </div>
        </xpath>
    </template>
    
    <!-- Página de términos y condiciones (sin cambios) -->
    <template id="terms_page" name="Términos y Condiciones">
        <!-- Contenido sin cambios -->
    </template>
    
    <!-- Agrega el script de Turnstile al head de la página para mejor compatibilidad -->
    <template id="turnstile_assets" inherit_id="web.assets_frontend">
        <xpath expr="//script[last()]" position="after">
            <script>
                // Función global para ser llamada cuando Turnstile está listo
                window.onTurnstileReady = function() {
                    console.log("[Turnstile-Template] Turnstile API lista para usar");
                }
            </script>
        </xpath>
    </template>
    
    <!-- Configura CSP para permitir Turnstile -->
    <template id="layout_turnstile" inherit_id="web.layout">
        <xpath expr="//meta[@name='viewport']" position="after">
            <meta http-equiv="Content-Security-Policy" content="
                script-src 'self' 'unsafe-inline' 'unsafe-eval' https://challenges.cloudflare.com;
                frame-src 'self' https://challenges.cloudflare.com;
                connect-src 'self' https://challenges.cloudflare.com;" 
                  t-if="request and request.httprequest.path == '/web/signup'"/>
        </xpath>
    </template>
    <!-- Página de términos y condiciones (si se necesita) -->
    <template id="terms_page" name="Términos y Condiciones">
        <t t-call="website.layout">
            <div class="container mt-4 mb-5">
                <h1 class="mb-4">Términos y Condiciones</h1>
                <div class="card">
                    <div class="card-body">
                        <h3>1. Aceptación de los Términos</h3>
                        <p>Al registrarse y utilizar nuestro servicio, usted acepta estos términos y
                            condiciones en su totalidad.</p>

                        <h3>2. Descripción del Servicio</h3>
                        <p>Proporcionamos una plataforma para gestión empresarial basada en Odoo. El
                            servicio puede cambiar con el tiempo según las actualizaciones del sistema.</p>

                        <h3>3. Registro y Seguridad</h3>
                        <p>Usted es responsable de mantener la confidencialidad de su cuenta y
                            contraseña. Notifíquenos de inmediato si cree que su cuenta ha sido
                            comprometida.</p>

                        <h3>4. Privacidad</h3>
                        <p>Su privacidad es importante para nosotros. Consulte nuestra Política de
                            Privacidad para entender cómo recopilamos, usamos y protegemos sus
                            datos.</p>

                        <h3>5. Conducta del Usuario</h3>
                        <p>Está prohibido usar el servicio para actividades ilegales o no
                            autorizadas. Nos reservamos el derecho de suspender cuentas que violen
                            estas condiciones.</p>

                        <h3>6. Propiedad Intelectual</h3>
                        <p>Todo el contenido y software asociado con el servicio está protegido por
                            leyes de propiedad intelectual.</p>

                        <h3>7. Terminación</h3>
                        <p>Podemos terminar o suspender su acceso al servicio inmediatamente, sin
                            previo aviso, por cualquier razón.</p>

                        <h3>8. Limitación de Responsabilidad</h3>
                        <p>No seremos responsables por daños indirectos, incidentales, especiales,
                            consecuentes o punitivos resultantes del uso de nuestro servicio.</p>

                        <h3>9. Cambios en los Términos</h3>
                        <p>Podemos modificar estos términos en cualquier momento. Es su
                            responsabilidad revisarlos periódicamente.</p>

                        <h3>10. Contacto</h3>
                        <p>Si tiene preguntas sobre estos términos, contáctenos a través de soporte@miempresa.com.</p>
                    </div>
                </div>
                <div class="d-flex justify-content-center mt-4">
                    <a href="/web/signup" class="btn btn-primary">Volver al Registro</a>
                </div>
            </div>
        </t>
    </template>
</odoo>